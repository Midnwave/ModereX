package zoruafan.foxanticheat.checks.misc.exploits;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.PacketType.Play.Client;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import java.util.HashMap;
import java.util.Map;
import org.bukkit.Bukkit;
import org.bukkit.GameMode;
import org.bukkit.entity.Player;
import org.bukkit.event.Listener;
import org.bukkit.plugin.java.JavaPlugin;
import zoruafan.foxanticheat.api.events.FoxFlagEvent;
import zoruafan.foxanticheat.manager.ChecksManager;
import zoruafan.foxanticheat.manager.FilesManager;
import zoruafan.foxanticheat.manager.FoliaCompat;

public class Packets extends ChecksManager implements Listener {
   private final JavaPlugin plugin;
   private final FilesManager file;
   private final HashMap<Player, Long> cooldowns = new HashMap();
   private final long cooldownTime = 200L;
   private final String p = "misc.modules.exploits.modules";
   boolean detected = false;
   String type = "";
   String detailed;

   public Packets(JavaPlugin plugin, FilesManager file) {
      super(file);
      this.plugin = plugin;
      this.file = file;
      this.registerPacketListener();
   }

   private void registerPacketListener() {
      ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(this.plugin, ListenerPriority.HIGH, new PacketType[]{Client.SET_CREATIVE_SLOT, Client.SPECTATE, Client.ABILITIES, Client.POSITION, Client.POSITION_LOOK}) {
         private final Map<Player, Integer> temporaryVls = new HashMap();

         public void onPacketReceiving(PacketEvent event) {
            Player e = event.getPlayer();
            if (!Packets.this.iAD(e, "misc")) {
               if (event.getPacketType() == Client.SET_CREATIVE_SLOT && Packets.this.file.getChecks().getBoolean("misc.modules.exploits.modules.fakecreative.enable", true)) {
                  if (e.getGameMode() == GameMode.CREATIVE) {
                     return;
                  }

                  event.setCancelled(true);
                  Packets.this.detected = true;
                  Packets.this.type = "FakeCreative";
                  Packets.this.detailed = "Creative mode in another gamemode!";
               }

               if (event.getPacketType() == Client.SPECTATE && Packets.this.file.getChecks().getBoolean("misc.modules.exploits.modules.fakespectate.enable", true)) {
                  if (e.getGameMode() == GameMode.SPECTATOR) {
                     return;
                  }

                  event.setCancelled(true);
                  Packets.this.detected = true;
                  Packets.this.type = "FakeSpectate";
                  Packets.this.detailed = "Spectate mode in another gamemode!";
               }

               if (event.getPacketType() == Client.ABILITIES && Packets.this.file.getChecks().getBoolean("misc.modules.exploits.modules.invalidabilities.enable", true)) {
                  boolean onGround = Packets.this.file.getChecks().getBoolean("misc.modules.exploits.modules.invalidabilities.onground", true);
                  boolean confirm = Packets.this.file.getChecks().getBoolean("misc.modules.exploits.modules.invalidabilities.confirm", true);
                  if (onGround && !e.isOnGround()) {
                     return;
                  }

                  if (e.getGameMode() == GameMode.CREATIVE || e.isFlying()) {
                     return;
                  }

                  FoliaCompat.runTaskTimerAsync(this.plugin, (FA) -> {
                     this.temporaryVls.getOrDefault(e, 0);
                  }, 40L, 40L);
                  if (confirm) {
                     int sumTVls = true;
                     this.incrementTemporaryVLS(e, 1);
                     int playerTVls = (Integer)this.temporaryVls.getOrDefault(e, 0);
                     if (playerTVls <= 2) {
                        return;
                     }
                  }

                  event.setCancelled(true);
                  Packets.this.detected = true;
                  Packets.this.type = "InvalidAbilities";
                  Packets.this.detailed = "Invalid Abilities packet!";
               }

               if ((event.getPacketType() == Client.POSITION || event.getPacketType() == Client.POSITION_LOOK) && Packets.this.file.getChecks().getBoolean("misc.modules.exploits.modules.invalidposition.enable", true)) {
                  double x = (Double)event.getPacket().getDoubles().readSafely(0);
                  double y = (Double)event.getPacket().getDoubles().readSafely(1);
                  double z = (Double)event.getPacket().getDoubles().readSafely(2);
                  double thresholdX = Math.abs(Packets.this.file.getChecks().getDouble("misc.modules.exploits.modules.invalidposition.x", 3.0E7D));
                  double thresholdY = Math.abs(Packets.this.file.getChecks().getDouble("misc.modules.exploits.modules.invalidposition.y", 3.0E7D));
                  double thresholdZ = Math.abs(Packets.this.file.getChecks().getDouble("misc.modules.exploits.modules.invalidposition.z", 3.0E7D));
                  if (Math.abs(x) > thresholdX || Math.abs(y) > thresholdY || Math.abs(z) > thresholdZ) {
                     event.setCancelled(true);
                     Packets.this.detected = true;
                     Packets.this.type = "InvalidPosition";
                     Packets.this.detailed = "Spectate mode in another gamemode!";
                  }
               }

               if (Packets.this.detected) {
                  Packets.this.detected = false;
                  if (!Packets.this.cooldowns.containsKey(e) || System.currentTimeMillis() >= (Long)Packets.this.cooldowns.get(e)) {
                     Packets.this.cooldowns.put(e, System.currentTimeMillis() + 200L);
                     FoxFlagEvent flagEvent = new FoxFlagEvent(e, "misc", 0, Packets.this.detailed, "Exploits", Packets.this.detailed);
                     FoliaCompat.runTask(this.plugin, (FA) -> {
                        Bukkit.getPluginManager().callEvent(flagEvent);
                        if (!flagEvent.isCancelled()) {
                           this.plugin.getLogger().warning("[AntiExploits] " + e.getName() + " has been detected for " + Packets.this.type + ".");
                           e.kickPlayer(Packets.this.file.getLang("exploits." + Packets.this.type.toLowerCase(), e));
                        }

                     });
                  }
               }
            }
         }

         private void incrementTemporaryVLS(Player e, int amount) {
            int currentVls = (Integer)this.temporaryVls.getOrDefault(e, 0);
            this.temporaryVls.put(e, currentVls + amount);
         }
      });
   }
}
